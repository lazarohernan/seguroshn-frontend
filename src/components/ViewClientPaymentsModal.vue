<script setup lang="ts">
import { ref, onBeforeUnmount } from 'vue'
import { X, FileText, Plus, AlertTriangle } from 'lucide-vue-next'
import ClientInfoCard from './payments/ClientInfoCard.vue'
import PaymentTable from './payments/PaymentTable.vue'
import AddPaymentForm from './payments/AddPaymentForm.vue'
import PaymentDetails from './payments/PaymentDetails.vue'
import ViewReceiptModal from './payments/ViewReceiptModal.vue'

interface Client {
  id: number
  name: string
  dni: string
  email: string
}

interface Policy {
  id: number
  name: string
  number: string
}

interface Payment {
  id: number
  amount: number
  date: string
  method: 'efectivo' | 'tarjeta' | 'transferencia'
  receipt?: File
}

interface NewPayment {
  amount: number
  date: string
  method: 'efectivo' | 'tarjeta' | 'transferencia'
  receipt?: File
}

defineProps<{
  show: boolean
  client: Client
  policy: Policy
}>()

const emit = defineEmits<{
  close: []
}>()

const showAddPaymentModal = ref(false)
const showPaymentDetailsModal = ref(false)
const showReceiptModal = ref(false)
const isEditing = ref(false)
const selectedPayment = ref<Payment | null>(null)
const originalPayment = ref<Payment | null>(null)
const showConfirmDialog = ref(false)
const receiptUrl = ref<string | null>(null)

// Datos de ejemplo para la tabla de pagos
const payments = ref<Payment[]>([
  {
    id: 1,
    amount: 1500,
    date: '2024-02-01',
    method: 'efectivo'
  },
  {
    id: 2,
    amount: 1500,
    date: '2024-03-01',
    method: 'tarjeta'
  },
  {
    id: 3,
    amount: 1500,
    date: '2024-04-01',
    method: 'transferencia'
  }
])

const handleAddPayment = (payment: NewPayment) => {
  // Aquí se manejaría la lógica para guardar el pago
  console.log('Nuevo pago:', payment)
  showAddPaymentModal.value = false
}

const handleViewPayment = (payment: Payment) => {
  selectedPayment.value = { ...payment }
  originalPayment.value = { ...payment }
  isEditing.value = false
  showPaymentDetailsModal.value = true
}

const handleEditPayment = (payment: Payment) => {
  selectedPayment.value = { ...payment }
  originalPayment.value = { ...payment }
  isEditing.value = true
  showPaymentDetailsModal.value = true
}

const handleSavePayment = (payment: Payment) => {
  // Aquí iría la lógica para guardar los cambios
  console.log('Guardando cambios:', payment)
  originalPayment.value = { ...payment }
  showPaymentDetailsModal.value = false
  selectedPayment.value = null
  originalPayment.value = null
  isEditing.value = false
}

const handleClose = () => {
  if (showAddPaymentModal.value || (showPaymentDetailsModal.value && isEditing.value)) {
    showConfirmDialog.value = true
  } else {
    emit('close')
  }
}

const handleConfirm = () => {
  if (showAddPaymentModal.value) {
    showAddPaymentModal.value = false
  } else if (showPaymentDetailsModal.value) {
    showPaymentDetailsModal.value = false
    selectedPayment.value = null
    originalPayment.value = null
    isEditing.value = false
  } else {
    emit('close')
  }
  showConfirmDialog.value = false
}

const handleViewReceipt = () => {
  if (selectedPayment.value?.receipt) {
    receiptUrl.value = URL.createObjectURL(selectedPayment.value.receipt)
    showReceiptModal.value = true
  }
}

const closeReceiptModal = () => {
  showReceiptModal.value = false
  if (receiptUrl.value) {
    URL.revokeObjectURL(receiptUrl.value)
    receiptUrl.value = null
  }
}

onBeforeUnmount(() => {
  if (receiptUrl.value) {
    URL.revokeObjectURL(receiptUrl.value)
  }
})
</script>

<template>
  <Teleport to="body">
    <div 
      v-if="show" 
      class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[1100] p-6" 
      @click="handleClose"
    >
      <div 
        class="w-full max-w-[900px] max-h-[calc(100vh-3rem)] bg-background border border-container-border rounded-3xl shadow-[0_8px_32px_var(--container-shadow)] flex flex-col" 
        @click.stop
      >
        <!-- Header -->
        <div class="sticky top-0 z-10 p-5 border-b border-container-border flex items-center justify-between bg-background backdrop-blur-sm rounded-t-3xl">
          <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded-lg bg-primary flex items-center justify-center">
              <FileText class="w-4 h-4 text-white" />
            </div>
            <h2 class="text-xl font-semibold text-text">Pagos de Póliza</h2>
          </div>
          <button 
            class="p-2 rounded-lg text-text transition-all duration-300 hover:bg-primary hover:text-white"
            @click="handleClose"
          >
            <X class="w-5 h-5" />
          </button>
        </div>
            
        <div class="flex-1 overflow-y-auto p-6 flex flex-col gap-6">
          <!-- Información del Cliente -->
          <ClientInfoCard :client="client" :policy="policy" />

          <!-- Sección de Pagos o Formulario -->
          <div v-if="!showAddPaymentModal && !showPaymentDetailsModal" class="flex flex-col gap-4">
            <div class="flex justify-between items-center mb-4">
              <div class="flex items-baseline gap-3">
                <h3 class="text-lg font-semibold text-text">Pagos Realizados</h3>
                <span class="text-sm text-text/70">{{ payments.length }} pagos</span>
              </div>
              <button 
                class="flex items-center gap-2 px-5 py-2.5 rounded-lg bg-primary text-white text-sm font-medium border-none transition-all duration-300 hover:bg-primary-hover hover:-translate-y-0.5 hover:shadow-lg"
                @click="showAddPaymentModal = true"
              >
                <Plus class="w-4 h-4" />
                <span>Agregar Pago</span>
              </button>
            </div>

            <!-- Tabla de Pagos -->
            <PaymentTable 
              :payments="payments"
              @view="handleViewPayment"
              @edit="handleEditPayment"
            />
          </div>

          <!-- Formulario de Pago -->
          <AddPaymentForm
            v-else-if="showAddPaymentModal"
            @save="handleAddPayment"
            @cancel="showAddPaymentModal = false"
          />

          <!-- Vista/Edición de Pago -->
          <PaymentDetails
            v-else-if="showPaymentDetailsModal && selectedPayment"
            :payment="selectedPayment"
            :is-editing="isEditing"
            @edit="isEditing = true"
            @save="handleSavePayment"
            @close="showPaymentDetailsModal = false"
            @view-receipt="handleViewReceipt"
          />
        </div>
      </div>
    </div>
  </Teleport>

  <!-- Modal de confirmación -->
  <div 
    v-if="showConfirmDialog" 
    class="fixed inset-0 bg-black/50 backdrop-blur-md flex items-center justify-center z-[1200] p-6"
    @click="showConfirmDialog = false"
  >
    <div 
      class="w-full max-w-[400px] bg-background rounded-2xl border border-container-border shadow-[0_8px_32px_var(--container-shadow)] p-6 sm:p-5"
      @click.stop
    >
      <div class="flex items-center gap-2 mb-4">
        <div class="w-8 h-8 rounded-full bg-amber-100 flex items-center justify-center">
          <AlertTriangle class="w-4 h-4 text-amber-500" />
        </div>
        <h3 class="text-lg font-semibold text-text">Confirmar Salida</h3>
      </div>
      
      <p class="text-base text-text/70 mb-6">Hay cambios sin guardar. ¿Está seguro que desea salir? Los cambios se perderán.</p>
      
      <div class="flex gap-3">
        <button 
          class="flex-1 px-4 py-2.5 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 border-none transition-all duration-300 hover:bg-primary hover:text-white"
          @click="showConfirmDialog = false"
        >
          Cancelar
        </button>
        <button 
          class="flex-1 px-4 py-2.5 rounded-lg text-sm font-medium bg-amber-500 text-white border-none transition-all duration-300 hover:bg-amber-600"
          @click="handleConfirm"
        >
          Salir sin Guardar
        </button>
      </div>
    </div>
  </div>

  <!-- Modal para ver comprobante -->
  <ViewReceiptModal
    v-if="showReceiptModal && receiptUrl"
    :show="showReceiptModal"
    :receipt-url="receiptUrl"
    @close="closeReceiptModal"
  />
</template>
